<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×§×•×¤×¡×ª ×”××•×¦×¨ - ××¢×¨×›×ª ×›×•×›×‘×™×</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 3em;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }
        
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        
        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .nav-tab.active {
            background: #ffd700;
            color: #1e3c72;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
        }
        
        .stats-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-value.total {
            color: #f59e0b;
            font-size: 3em;
        }
        
        .page-section {
            display: none;
        }
        
        .page-section.active {
            display: block;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .game-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .game-section h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 30px;
        }
        
        .chest-container {
            margin: 50px auto;
            width: 100%;
            max-width: 1100px;
            min-height: 400px;
            position: relative;
            perspective: 1000px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            flex-wrap: wrap;
        }
        
        .chest {
            width: 280px;
            height: 350px;
            position: relative;
            transform-style: preserve-3d;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .chest:hover:not(.opened):not(.revealed) {
            transform: scale(1.08);
            filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.5));
        }
        
        .chest.disabled {
            pointer-events: none;
            opacity: 0.6;
        }
        
        .chest-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 50%, #8B4513 100%);
            border-radius: 20px;
            box-shadow: 
                inset -10px -10px 20px rgba(0, 0, 0, 0.4),
                inset 10px 10px 20px rgba(139, 90, 43, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.5);
            border: 8px solid #654321;
        }
        
        .chest-lock {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform: translate(-50%, 50%);
            width: 60px;
            height: 70px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 10px;
            box-shadow: 
                0 5px 15px rgba(0, 0, 0, 0.4),
                inset 2px 2px 5px rgba(255, 255, 255, 0.5);
            z-index: 3;
        }
        
        .chest-lock::before {
            content: 'ğŸ”’';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
        }
        
        .chest.opened .chest-lock {
            opacity: 0;
            transform: translate(-50%, 50%) scale(0);
        }
        
        .chest-lid {
            position: absolute;
            bottom: 160px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, #A0522D 0%, #8B4513 50%, #A0522D 100%);
            border-radius: 50% 50% 20px 20px;
            border: 8px solid #654321;
            box-shadow: 
                inset -10px -10px 20px rgba(0, 0, 0, 0.4),
                inset 10px 10px 20px rgba(160, 82, 45, 0.4),
                0 10px 30px rgba(0, 0, 0, 0.5);
            transform-origin: bottom center;
            transition: transform 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 2;
        }
        
        .chest.opened .chest-lid {
            transform: translateX(-50%) rotateX(-120deg);
        }
        
        .chest-metal {
            position: absolute;
            background: linear-gradient(90deg, #C0C0C0 0%, #808080 50%, #C0C0C0 100%);
            box-shadow: 
                inset 1px 1px 3px rgba(255, 255, 255, 0.5),
                inset -1px -1px 3px rgba(0, 0, 0, 0.5);
        }
        
        .metal-strip-1 {
            width: 100%;
            height: 15px;
            top: 30%;
            left: 0;
        }
        
        .metal-strip-2 {
            width: 100%;
            height: 15px;
            bottom: 30%;
            left: 0;
        }
        
        .metal-corner {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }
        
        .corner-tl { top: 10px; left: 10px; }
        .corner-tr { top: 10px; right: 10px; }
        .corner-bl { bottom: 10px; left: 10px; }
        .corner-br { bottom: 10px; right: 10px; }
        
        .treasure-glow {
            position: absolute;
            bottom: 160px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 180px;
            background: radial-gradient(circle at center, 
                rgba(255, 215, 0, 0.8) 0%, 
                rgba(255, 215, 0, 0.4) 50%,
                rgba(255, 215, 0, 0) 100%);
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            filter: blur(20px);
        }
        
        .chest.opened .treasure-glow {
            opacity: 1;
            animation: glow-pulse 2s ease-in-out infinite;
        }
        
        @keyframes glow-pulse {
            0%, 100% { 
                opacity: 0.8;
                transform: translateX(-50%) scale(1);
            }
            50% { 
                opacity: 1;
                transform: translateX(-50%) scale(1.2);
            }
        }
        
        .prize-container {
            position: absolute;
            bottom: 180px;
            left: 50%;
            transform: translate(-50%, 0) scale(0);
            opacity: 0;
            transition: all 0.6s;
            z-index: 1;
        }
        
        .chest.opened .prize-container {
            transform: translate(-50%, -50px) scale(1);
            opacity: 1;
            animation: prize-float 0.8s ease-out 0.5s;
        }
        
        @keyframes prize-float {
            0% { transform: translate(-50%, 0) scale(1); }
            50% { transform: translate(-50%, -80px) scale(1.3); }
            100% { transform: translate(-50%, -50px) scale(1); }
        }
        
        .prize-stars {
            font-size: 3.5em;
            font-weight: bold;
            color: #f59e0b;
            text-shadow: 
                3px 3px 6px rgba(0,0,0,0.5),
                0 0 30px rgba(245, 158, 11, 0.8),
                0 0 60px rgba(245, 158, 11, 0.4);
            animation: prize-glow 1.5s ease-in-out infinite;
        }
        
        @keyframes prize-glow {
            0%, 100% { 
                text-shadow: 
                    3px 3px 6px rgba(0,0,0,0.5),
                    0 0 30px rgba(245, 158, 11, 0.8),
                    0 0 60px rgba(245, 158, 11, 0.4);
            }
            50% { 
                text-shadow: 
                    3px 3px 6px rgba(0,0,0,0.5),
                    0 0 50px rgba(245, 158, 11, 1),
                    0 0 100px rgba(245, 158, 11, 0.6);
            }
        }
        
        .instruction {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        button {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.4em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
            margin-top: 20px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.6);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .result {
            margin-top: 30px;
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
            min-height: 50px;
        }
        
        .history-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .history-section h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-item {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .history-date {
            font-size: 0.9em;
            color: #666;
        }
        
        .history-stars {
            font-size: 1.5em;
            font-weight: bold;
            color: #f59e0b;
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            animation: confetti-fall 3s linear forwards;
        }
        
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #95e1d3, #68d8c4);
            padding: 10px 20px;
            font-size: 1em;
            margin-top: 20px;
        }
        
        .backup-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 10px 20px;
            font-size: 1em;
            margin-top: 10px;
        }
        
        .restore-btn {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            padding: 10px 20px;
            font-size: 1em;
            margin-top: 10px;
        }
        
        .empty-history {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 1.2em;
        }
        
        .store-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .store-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .store-header h2 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .store-tip {
            background: linear-gradient(135deg, #ffd89b, #19547b);
            color: white;
            padding: 15px 30px;
            border-radius: 20px;
            font-size: 1.1em;
            max-width: 700px;
            margin: 20px auto;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            font-weight: bold;
        }
        
        .store-tip::before {
            content: 'ğŸ’¡ ';
            font-size: 1.3em;
        }
        
        .parents-note {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            color: #333;
            padding: 12px 25px;
            border-radius: 15px;
            font-size: 0.95em;
            max-width: 700px;
            margin: 15px auto;
            box-shadow: 0 3px 15px rgba(0,0,0,0.15);
        }
        
        .parents-note::before {
            content: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ';
            font-size: 1.2em;
        }
        
        .store-tabs {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        
        .store-tab {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 2px solid #667eea;
            padding: 12px 30px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .store-tab:hover {
            background: rgba(102, 126, 234, 0.2);
        }
        
        .store-tab.active {
            background: #667eea;
            color: white;
        }
        
        .prizes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .prize-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .prize-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .prize-card.purchased {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .prize-card.purchased::after {
            content: 'âœ… × ×¨×›×©';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4ecdc4;
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .prize-card.owned {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 3px solid #4caf50;
        }
        
        .owned-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4caf50;
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
        }
        
        .use-btn {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border: none;
            padding: 10px 25px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .use-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }
        
        .use-btn.used {
            background: #9e9e9e;
            cursor: not-allowed;
        }
        
        .empty-closet {
            text-align: center;
            color: #999;
            padding: 60px 20px;
            font-size: 1.3em;
        }
        
        .empty-closet-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .prize-emoji {
            font-size: 4em;
            margin-bottom: 15px;
        }
        
        .prize-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .prize-cost {
            font-size: 1.5em;
            font-weight: bold;
            color: #f59e0b;
            margin-bottom: 15px;
        }
        
        .buy-btn {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 10px 25px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .buy-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }
        
        .buy-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .store-category {
            display: none;
        }
        
        .store-category.active {
            display: block;
        }
        
        .category-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 20px;
            text-align: right;
            font-weight: bold;
        }
        
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .preview-modal.active {
            display: flex;
        }
        
        .preview-content {
            background: white;
            border-radius: 30px;
            width: 90%;
            max-width: 900px;
            height: 80%;
            max-height: 700px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .preview-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .preview-header h3 {
            font-size: 1.8em;
            margin: 0;
        }
        
        .preview-timer {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
            margin-top: 15px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            padding: 10px 25px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            display: inline-block;
        }
        
        .preview-timer.warning {
            color: #ff6b6b;
            animation: pulse-timer 0.5s ease-in-out infinite;
            background: rgba(255, 107, 107, 0.3);
        }
        
        @keyframes pulse-timer {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        
        .preview-close {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-close:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: rotate(90deg);
        }
        
        .preview-iframe-container {
            flex: 1;
            position: relative;
            background: #f5f5f5;
        }
        
        .preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .preview-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 20px;
            font-size: 0.9em;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .preview-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ’ ×§×•×¤×¡×ª ×”××•×¦×¨ ğŸ’</h1>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchPage('treasure')">×§×•×¤×¡×ª ××•×¦×¨ ğŸ’</button>
        <button class="nav-tab" onclick="switchPage('store')">×—× ×•×ª ğŸª</button>
        <button class="nav-tab" onclick="switchPage('closet')">×”××¨×•×Ÿ ×©×œ×™ ğŸ‘•</button>
        <button class="nav-tab" onclick="switchPage('history')">×”×™×¡×˜×•×¨×™×” ğŸ“œ</button>
    </div>

    <div class="stats-bar">
        <div class="stat-item">
            <div class="stat-label">×¡×š ×”×›×œ ×›×•×›×‘×™×</div>
            <div class="stat-value total" id="totalStars">0</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">×§×•×¤×¡××•×ª ×”×™×•×</div>
            <div class="stat-value" id="chestsToday">0</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">×¨×¦×£ ×™××™× ğŸ”¥</div>
            <div class="stat-value" id="streak">0</div>
        </div>
    </div>

    <div id="treasurePage" class="page-section active">
        <div class="main-content">
            <div class="game-section">
                <h2>×¤×ª×— ××ª ×§×•×¤×¡×ª ×”××•×¦×¨!</h2>
                <p class="subtitle">×¡×™×™××ª 25 ×“×§×•×ª ×©×œ ×œ×™××•×“ ××¦×•×™×Ÿ</p>
                <p class="instruction" id="instruction">×‘×—×¨ ×ª×™×‘×” ××—×ª ××ª×•×š 3! ğŸ²</p>
                
                <div class="chest-container" id="chestContainer">
                    <!-- Chests will be generated by JavaScript -->
                </div>
                
                <button id="resetBtn">×§×•×¤×¡×” ×—×“×©×”! ğŸ’</button>
                
                <div class="result" id="result"></div>
            </div>

            <div class="history-section">
                <h2>×”×’×“×¨×•×ª ×”×•×¨×™× ğŸ”’</h2>
                <button class="backup-btn" id="backupBtn">×’×™×‘×•×™ × ×ª×•× ×™× ğŸ’¾</button>
                <button class="restore-btn" id="restoreBtn">×©×—×–×•×¨ × ×ª×•× ×™× ğŸ“¥</button>
                <button class="reset-btn" id="resetDataBtn">××™×¤×•×¡ × ×ª×•× ×™× âš ï¸</button>
                <input type="file" id="fileInput" accept=".json" style="display: none;">
            </div>
        </div>
    </div>

    <div id="storePage" class="page-section">
        <div class="store-container">
            <div class="store-header">
                <h2>×—× ×•×ª ×”×“××•×™×•×ª ×•×”×§×•×¤×•× ×™× ğŸª</h2>
                <div class="store-tip">
                    ×‘×œ×—×™×¦×” ×¢×œ "×ª×¦×•×’×” ××§×“×™××”" × ×™×ª×Ÿ ×œ×¨××•×ª ××ª ×”×¤×¨×™×˜ 15 ×©× ×™×•×ª
                </div>
                <div class="parents-note">
                    ×”×¢×¨×” ×œ×”×•×¨×™×: ×”×§×•×¤×•× ×™× ×”× ×”×¦×¢×•×ª ×’××™×©×•×ª - ×ª××™×“ ××¤×©×¨ ×œ×”×ª××™× ×œ××” ×©××ª××™× ×œ××©×¤×—×” ×©×œ×›×
                </div>
            </div>

            <div class="store-tabs">
                <button class="store-tab active" onclick="switchStoreCategory('digital')">×“××•×™×•×ª ×•×¤×¨×™×˜×™× ğŸ¦Š</button>
                <button class="store-tab" onclick="switchStoreCategory('coupons')">×§×•×¤×•× ×™× ğŸ</button>
            </div>

            <div id="digitalCategory" class="store-category active">
                <h3 class="category-title">×“××•×™×•×ª ×•×¤×¨×™×˜×™× ğŸ¾</h3>
                <div class="prizes-grid" id="digitalPrizes"></div>
            </div>

            <div id="couponsCategory" class="store-category">
                <h3 class="category-title">×§×•×¤×•× ×™× ğŸ</h3>
                <div class="prizes-grid" id="couponPrizes"></div>
            </div>
        </div>
    </div>

    <div id="historyPage" class="page-section">
        <div class="store-container">
            <div class="store-header">
                <h2>ğŸ“œ ×”×™×¡×˜×•×¨×™×™×ª ×–×›×™×•×ª</h2>
            </div>
            <div class="history-list" id="historyList">
                <div class="empty-history">×¢×“×™×™×Ÿ ×œ× ×¤×ª×—×ª ×§×•×¤×¡××•×ª ××•×¦×¨ ğŸ’</div>
            </div>
        </div>
    </div>

    <div id="closetPage" class="page-section">
        <div class="store-container">
            <div class="store-header">
                <h2>ğŸ‘• ×”××¨×•×Ÿ ×©×œ×™</h2>
                <p class="subtitle">×›×œ ×”×¤×¨×™×˜×™× ×©×¨×›×©×ª!</p>
            </div>

            <div class="store-tabs">
                <button class="store-tab active" onclick="switchClosetCategory('digital')">×“××•×™×•×ª ×•×¤×¨×™×˜×™× ğŸ¦Š</button>
                <button class="store-tab" onclick="switchClosetCategory('coupons')">×§×•×¤×•× ×™× ğŸ</button>
            </div>

            <div id="myDigitalCategory" class="store-category active">
                <h3 class="category-title">×“××•×™×•×ª ×•×¤×¨×™×˜×™× ğŸ¾</h3>
                <div class="prizes-grid" id="myDigitalItems"></div>
            </div>

            <div id="myCouponsCategory" class="store-category">
                <h3 class="category-title">×”×§×•×¤×•× ×™× ×©×œ×™ ğŸ</h3>
                <div class="prizes-grid" id="myCouponItems"></div>
            </div>
        </div>
    </div>

    <div id="previewModal" class="preview-modal">
        <div class="preview-content">
            <div class="preview-header">
                <button class="preview-close" onclick="closePreview()">âœ•</button>
                <h3 id="previewTitle">×ª×¦×•×’×” ××§×“×™××”</h3>
                <div class="preview-timer" id="previewTimer">â±ï¸ 15 ×©× ×™×•×ª</div>
            </div>
            <div class="preview-iframe-container">
                <iframe id="previewIframe" class="preview-iframe" src=""></iframe>
            </div>
        </div>
    </div>

    <script>
        const prizes = [5, 7, 9];
        let currentPrizes = [];
        let selectedChestIndex = null;
        
        const storeItems = {
            digital: [
                { id: 'rabbit', name: '××¨× ×‘', emoji: 'ğŸ°', cost: 10, url: 'https://silverhasamot-stack.github.io/game-master/rabbit.html' },
                { id: 'fox', name: '×©×•×¢×œ', emoji: 'ğŸ¦Š', cost: 35, url: 'https://silverhasamot-stack.github.io/game-master/fox.html' },
                { id: 'bear', name: '×“×•×‘', emoji: 'ğŸ»', cost: 35, url: 'https://silverhasamot-stack.github.io/game-master/bear.html' },
                { id: 'dog', name: '×›×œ×‘', emoji: 'ğŸ¶', cost: 35, url: 'https://silverhasamot-stack.github.io/game-master/dog.html' },
                { id: 'lion', name: '××¨×™×”', emoji: 'ğŸ¦', cost: 35, url: 'https://silverhasamot-stack.github.io/game-master/lion.html' },
                { id: 'frog', name: '×¦×¤×¨×“×¢', emoji: 'ğŸ¸', cost: 35, url: 'https://silverhasamot-stack.github.io/game-master/frog.html' },
                { id: 'penguin', name: '×¤×™× ×’×•×•×™×Ÿ', emoji: 'ğŸ§', cost: 40, url: 'https://silverhasamot-stack.github.io/game-master/Penguin.html' },
                { id: 'owl', name: '×™× ×©×•×£', emoji: 'ğŸ¦‰', cost: 35, url: 'https://silverhasamot-stack.github.io/game-master/owl.html' },
                { id: 'snake', name: '× ×—×©', emoji: 'ğŸ', cost: 35, url: 'https://silverhasamot-stack.github.io/game-master/snake.html' },
                { id: 'elephant', name: '×¤×™×œ', emoji: 'ğŸ˜', cost: 35, url: 'https://silverhasamot-stack.github.io/game-master/Elephant.html' },
                { id: 'magician', name: '×§×•×¡×', emoji: 'ğŸ§™', cost: 40, url: 'https://silverhasamot-stack.github.io/game-master/magician.html' },
                { id: 'pandacub', name: '×’×•×¨ ×¤× ×“×”', emoji: 'ğŸ¼', cost: 45, url: 'https://silverhasamot-stack.github.io/game-master/pandacub.html' },
                { id: 'rooster', name: '×ª×¨× ×’×•×œ', emoji: 'ğŸ“', cost: 40, url: 'https://silverhasamot-stack.github.io/game-master/rooster.html' },
                { id: 'magic-canvas', name: '×œ×•×— ×¦×™×•×¨ ×”×§×¡×', emoji: 'ğŸ¨', cost: 45, url: 'https://silverhasamot-stack.github.io/game-master/magic-canvas.html' },
                { id: 'magic-clock', name: '×©×¢×•×Ÿ ×§×¡×•×', emoji: 'ğŸ•', cost: 40, url: 'https://silverhasamot-stack.github.io/game-master/magice-klock.html' },
                { id: 'fireworks', name: '××•×¤×¢ ×–×™×§×•×§×™×', emoji: 'ğŸ†', cost: 40, url: 'https://silverhasamot-stack.github.io/game-master/Fireworks-show.html' },
                { id: 'magic-book', name: '×¡×¤×¨ ×”×§×¡××™×', emoji: 'ğŸ“–', cost: 40, url: 'https://silverhasamot-stack.github.io/game-master/magic-book.html' },
                { id: 'lego-building', name: '×‘× ×™×™×ª ×¦×•×¨×•×ª ×œ×’×•', emoji: 'ğŸ§±', cost: 45, url: 'https://silverhasamot-stack.github.io/game-master/Lego-building-shapes.html' },
                { id: 'learning-draw', name: '×œ×™××•×“ ×¦×™×•×¨×™×', emoji: 'âœï¸', cost: 40, url: 'https://silverhasamot-stack.github.io/game-master/learning-to-draw.html' },
                { id: 'melody-maker', name: '×™×•×¦×¨ ×× ×’×™× ×•×ª', emoji: 'ğŸµ', cost: 45, url: 'https://silverhasamot-stack.github.io/game-master/Melodymaker.html' }
            ],
            coupons: [
                { id: 'icecream', name: '×’×œ×™×“×” ××”×•×‘×”', emoji: 'ğŸ¦', cost: 50 },
                { id: 'dessert', name: '×¢×•×’×”/×§×™× ×•×— ××™×•×—×“', emoji: 'ğŸ°', cost: 70 },
                { id: 'agreement', name: '×§×•×¤×•×Ÿ ×”×¡×›××”', emoji: 'ğŸ¤', cost: 75 },
                { id: 'book', name: '×¡×¤×¨ ×œ×‘×—×™×¨×”', emoji: 'ğŸ“š', cost: 80 },
                { id: 'pizza', name: '×¤×™×¦×” ××©×¤×—×ª×™×ª', emoji: 'ğŸ•', cost: 100 },
                { id: 'pizza-movie', name: '×¢×¨×‘ ×¤×™×¦×” ×•×¡×¨×˜ ×‘×‘×™×ª', emoji: 'ğŸ‚', cost: 115 },
                { id: 'toy', name: '×¦×¢×¦×•×¢ ×§×˜×Ÿ', emoji: 'ğŸ§¸', cost: 120 },
                { id: 'show', name: '×”×¦×’×”/××•×¤×¢ ×™×œ×“×™×', emoji: 'ğŸª', cost: 150 },
                { id: 'agreement-special', name: '×§×•×¤×•×Ÿ ×”×¡×›××” ××™×•×—×“', emoji: 'ğŸ¤', cost: 150 },
                { id: 'bowling', name: '×‘××•×œ×™× ×’ ××©×¤×—×ª×™', emoji: 'ğŸ³', cost: 180 },
                { id: 'game', name: '××©×—×§ ×—×“×©', emoji: 'ğŸ®', cost: 200 },
                { id: 'park', name: '×™×•× ×‘×¤××¨×§ ×©×¢×©×•×¢×™×', emoji: 'ğŸ¡', cost: 300 }
            ]
        };
        
        let gameData = {
            totalStars: 0,
            chestsToday: 0,
            streak: 0,
            history: [],
            lastOpenDate: null,
            lastResetDate: new Date().toDateString(),
            purchases: []
        };
        
        function shufflePrizes() {
            currentPrizes = [...prizes].sort(() => Math.random() - 0.5);
        }
        
        function createChests() {
            const container = document.getElementById('chestContainer');
            container.innerHTML = '';
            
            for (let i = 0; i < 3; i++) {
                const chestDiv = document.createElement('div');
                chestDiv.className = 'chest';
                chestDiv.id = `chest${i}`;
                chestDiv.setAttribute('data-index', i);
                chestDiv.onclick = () => openChest(i);
                
                chestDiv.innerHTML = `
                    <div class="treasure-glow"></div>
                    <div class="chest-base">
                        <div class="chest-metal metal-strip-1"></div>
                        <div class="chest-metal metal-strip-2"></div>
                        <div class="chest-metal metal-corner corner-tl"></div>
                        <div class="chest-metal metal-corner corner-tr"></div>
                        <div class="chest-metal metal-corner corner-bl"></div>
                        <div class="chest-metal metal-corner corner-br"></div>
                    </div>
                    <div class="chest-lid">
                        <div class="chest-metal metal-strip-1"></div>
                        <div class="chest-metal metal-corner corner-tl"></div>
                        <div class="chest-metal metal-corner corner-tr"></div>
                    </div>
                    <div class="chest-lock"></div>
                    <div class="prize-container">
                        <div class="prize-stars"></div>
                    </div>
                `;
                
                container.appendChild(chestDiv);
            }
        }
        
        function switchPage(page) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (page === 'treasure') {
                document.getElementById('treasurePage').classList.add('active');
                event.target.classList.add('active');
            } else if (page === 'store') {
                document.getElementById('storePage').classList.add('active');
                event.target.classList.add('active');
                renderStore();
            } else if (page === 'closet') {
                document.getElementById('closetPage').classList.add('active');
                event.target.classList.add('active');
                renderCloset();
            } else if (page === 'history') {
                document.getElementById('historyPage').classList.add('active');
                event.target.classList.add('active');
            }
        }
        
        function switchClosetCategory(category) {
            document.querySelectorAll('.store-category').forEach(cat => {
                cat.classList.remove('active');
            });
            document.querySelectorAll('.store-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (category === 'digital') {
                document.getElementById('myDigitalCategory').classList.add('active');
            } else {
                document.getElementById('myCouponsCategory').classList.add('active');
            }
            event.target.classList.add('active');
        }
        
        function switchStoreCategory(category) {
            document.querySelectorAll('.store-category').forEach(cat => {
                cat.classList.remove('active');
            });
            document.querySelectorAll('.store-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (category === 'digital') {
                document.getElementById('digitalCategory').classList.add('active');
            } else {
                document.getElementById('couponsCategory').classList.add('active');
            }
            event.target.classList.add('active');
        }
        
        function renderStore() {
            renderPrizes('digital', 'digitalPrizes');
            renderPrizes('coupons', 'couponPrizes');
        }
        
        function renderCloset() {
            renderMyItems('digital', 'myDigitalItems');
            renderMyItems('coupons', 'myCouponItems');
        }
        
        function renderMyItems(category, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (category === 'digital') {
                const myItems = storeItems[category].filter(item => gameData.purchases.includes(item.id));
                
                if (myItems.length === 0) {
                    container.innerHTML = `
                        <div class="empty-closet">
                            <div class="empty-closet-icon">ğŸ˜¢</div>
                            <div>×¢×“×™×™×Ÿ ×œ× ×¨×›×©×ª ×¤×¨×™×˜×™× ××§×˜×’×•×¨×™×” ×–×•</div>
                            <div style="margin-top: 10px; font-size: 0.9em; color: #666;">×œ×š ×œ×—× ×•×ª ×›×“×™ ×œ×§× ×•×ª!</div>
                        </div>
                    `;
                    return;
                }
                
                myItems.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'prize-card owned';
                    
                    card.innerHTML = `
                        <div class="owned-badge">×©×œ×™! ğŸ‰</div>
                        <div class="prize-emoji">${item.emoji}</div>
                        <div class="prize-name">${item.name}</div>
                        <div class="prize-cost" style="color: #4caf50;">âœ… × ×¨×›×©</div>
                        <button class="use-btn" onclick="playDigitalItem('${item.url}')">×©×—×§! ğŸ®</button>
                    `;
                    
                    container.appendChild(card);
                });
            } else {
                if (!gameData.couponInventory || Object.keys(gameData.couponInventory).length === 0) {
                    container.innerHTML = `
                        <div class="empty-closet">
                            <div class="empty-closet-icon">ğŸ˜¢</div>
                            <div>×¢×“×™×™×Ÿ ×œ× ×¨×›×©×ª ×§×•×¤×•× ×™×</div>
                            <div style="margin-top: 10px; font-size: 0.9em; color: #666;">×œ×š ×œ×—× ×•×ª ×›×“×™ ×œ×§× ×•×ª!</div>
                        </div>
                    `;
                    return;
                }
                
                Object.keys(gameData.couponInventory).forEach(itemId => {
                    const item = storeItems.coupons.find(i => i.id === itemId);
                    const coupons = gameData.couponInventory[itemId];
                    
                    coupons.forEach((coupon, index) => {
                        const card = document.createElement('div');
                        card.className = 'prize-card owned';
                        
                        const purchaseDate = new Date(coupon.purchaseDate);
                        const dateStr = purchaseDate.toLocaleDateString('he-IL');
                        
                        card.innerHTML = `
                            <div class="owned-badge">×©×œ×™! ğŸ‰</div>
                            <div class="prize-emoji">${item.emoji}</div>
                            <div class="prize-name">${item.name}</div>
                            <div style="font-size: 0.85em; color: #666; margin: 10px 0;">× ×¨×›×©: ${dateStr}</div>
                            <button class="use-btn ${coupon.used ? 'used' : ''}" 
                                    onclick="useCoupon('${itemId}', ${index})" 
                                    ${coupon.used ? 'disabled' : ''}>
                                ${coupon.used ? '× ×•×¦×œ âœ…' : '×”×©×ª××©! ğŸ'}
                            </button>
                        `;
                        
                        container.appendChild(card);
                    });
                });
            }
        }
        
        function playDigitalItem(url) {
            window.open(url, '_blank');
        }
        
        function useCoupon(itemId, couponIndex) {
            if (!gameData.couponInventory || !gameData.couponInventory[itemId]) {
                return;
            }
            
            const coupon = gameData.couponInventory[itemId][couponIndex];
            
            if (coupon.used) {
                alert('×›×‘×¨ ×”×©×ª××©×ª ×‘×§×•×¤×•×Ÿ ×”×–×”! âœ…');
                return;
            }
            
            const item = storeItems.coupons.find(i => i.id === itemId);
            
            if (confirm(`×”×× ×”×©×ª××©×ª ×‘${item.name}? ×œ××—×¨ ××™×©×•×¨, ×”×§×•×¤×•×Ÿ ×™×¡×•××Ÿ ×›"× ×•×¦×œ".`)) {
                coupon.used = true;
                coupon.usedDate = new Date().toISOString();
                saveData();
                renderCloset();
                alert('×”×§×•×¤×•×Ÿ ×¡×•××Ÿ ×›× ×•×¦×œ! ×›×œ ×”×›×‘×•×“! ğŸ‰');
            }
        }
        
        function renderPrizes(category, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            storeItems[category].forEach(item => {
                const canAfford = gameData.totalStars >= item.cost;
                
                const card = document.createElement('div');
                card.className = 'prize-card';
                
                const previewBtn = (category === 'digital' && item.url) 
                    ? `<button class="preview-btn" onclick="openPreview('${item.name}', '${item.url}')">ğŸ‘ï¸ ×ª×¦×•×’×” ××§×“×™××”</button>` 
                    : '';
                
                const isPurchased = gameData.purchases.includes(item.id);
                const purchasedBadge = (category === 'digital' && isPurchased) ? '<div style="position: absolute; top: 10px; right: 10px; background: #4ecdc4; color: white; padding: 5px 10px; border-radius: 10px; font-size: 0.8em; font-weight: bold;">âœ… × ×¨×›×©</div>' : '';
                
                if (category === 'digital' && isPurchased) {
                    card.classList.add('purchased');
                }
                
                card.innerHTML = `
                    ${purchasedBadge}
                    <div class="prize-emoji">${item.emoji}</div>
                    <div class="prize-name">${item.name}</div>
                    <div class="prize-cost">â­ ${item.cost}</div>
                    ${previewBtn}
                    ${(category === 'digital' && isPurchased) ? '' : `<button class="buy-btn" onclick="buyItem('${item.id}', ${item.cost}, '${category}')" ${!canAfford ? 'disabled' : ''}>
                        ${canAfford ? '×§× ×” ×¢×›×©×™×•! ğŸ›’' : '××™×Ÿ ××¡×¤×™×§ ×›×•×›×‘×™× ğŸ˜¢'}
                    </button>`}
                `;
                
                container.appendChild(card);
            });
        }
        
        let previewTimerInterval = null;
        let previewTimeLeft = 0;
        
        function openPreview(name, url) {
            const modal = document.getElementById('previewModal');
            const iframe = document.getElementById('previewIframe');
            const title = document.getElementById('previewTitle');
            const timerDisplay = document.getElementById('previewTimer');
            
            title.textContent = name + ' - ×ª×¦×•×’×” ××§×“×™××” ğŸ‘ï¸';
            iframe.src = url;
            modal.classList.add('active');
            
            previewTimeLeft = 15;
            updateTimerDisplay();
            
            if (previewTimerInterval) {
                clearInterval(previewTimerInterval);
            }
            
            previewTimerInterval = setInterval(() => {
                previewTimeLeft--;
                updateTimerDisplay();
                
                if (previewTimeLeft <= 0) {
                    clearInterval(previewTimerInterval);
                    closePreview();
                    alert('â° ×–××Ÿ ×”×ª×¦×•×’×” ×”××§×“×™××” × ×’××¨!\n\nğŸ’¡ ×¨×•×¦×” ×œ×©×—×§ ×™×•×ª×¨? ×§× ×” ××ª ×”×¤×¨×™×˜ ×‘×—× ×•×ª! â­');
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const timerDisplay = document.getElementById('previewTimer');
            timerDisplay.textContent = `â±ï¸ ${previewTimeLeft} ×©× ×™×•×ª`;
            
            if (previewTimeLeft <= 5) {
                timerDisplay.classList.add('warning');
            } else {
                timerDisplay.classList.remove('warning');
            }
        }
        
        function closePreview() {
            const modal = document.getElementById('previewModal');
            const iframe = document.getElementById('previewIframe');
            const timerDisplay = document.getElementById('previewTimer');
            
            modal.classList.remove('active');
            iframe.src = '';
            
            if (previewTimerInterval) {
                clearInterval(previewTimerInterval);
                previewTimerInterval = null;
            }
            
            timerDisplay.classList.remove('warning');
            previewTimeLeft = 0;
        }
        
        function buyItem(itemId, cost, category) {
            if (gameData.totalStars < cost) {
                alert('××™×Ÿ ×œ×š ××¡×¤×™×§ ×›×•×›×‘×™×! ğŸ˜¢');
                return;
            }
            
            const item = [...storeItems.digital, ...storeItems.coupons].find(i => i.id === itemId);
            
            if (category === 'digital' && gameData.purchases.includes(itemId)) {
                alert('×›×‘×¨ ×§× ×™×ª ××ª ×”×¤×¨×™×˜ ×”×–×”! âœ…');
                return;
            }
            
            if (confirm(`×”×× ××ª×” ×‘×˜×•×— ×©××ª×” ×¨×•×¦×” ×œ×§× ×•×ª ${item.name} ×‘-${cost} ×›×•×›×‘×™×?`)) {
                gameData.totalStars -= cost;
                
                if (category === 'digital' && !gameData.purchases.includes(itemId)) {
                    gameData.purchases.push(itemId);
                }
                
                if (category === 'coupons') {
                    if (!gameData.couponInventory) {
                        gameData.couponInventory = {};
                    }
                    if (!gameData.couponInventory[itemId]) {
                        gameData.couponInventory[itemId] = [];
                    }
                    gameData.couponInventory[itemId].push({
                        purchaseDate: new Date().toISOString(),
                        used: false
                    });
                }
                
                saveData();
                updateUI();
                renderStore();
                
                createConfetti();
                alert('×›×œ ×”×›×‘×•×“! ×”×¤×¨×™×˜ × ×¨×›×© ×‘×”×¦×œ×—×”! ğŸ‰');
            }
        }
        
        function backupData() {
            const parentCode = prompt('×”×–×Ÿ ×§×•×“ ×”×•×¨×™× ×œ×’×™×‘×•×™ (4 ×¡×¤×¨×•×ª):');
            
            if (parentCode === null) {
                return;
            }
            
            if (parentCode !== '1234') {
                alert('×§×•×“ ×©×’×•×™! âŒ');
                return;
            }
            
            const dataStr = JSON.stringify(gameData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const today = new Date();
            const dateStr = today.getFullYear() + '-' + 
                          String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(today.getDate()).padStart(2, '0');
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'treasure-backup-' + dateStr + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('×”×’×™×‘×•×™ × ×©××¨ ×‘×”×¦×œ×—×”! ğŸ’¾\n×©××•×¨ ××ª ×”×§×•×‘×¥ ×‘××§×•× ×‘×˜×•×—.');
        }
        
        function restoreData(event) {
            const parentCode = prompt('×”×–×Ÿ ×§×•×“ ×”×•×¨×™× ×œ×©×—×–×•×¨ (4 ×¡×¤×¨×•×ª):');
            
            if (parentCode === null) {
                event.target.value = '';
                return;
            }
            
            if (parentCode !== '1234') {
                alert('×§×•×“ ×©×’×•×™! âŒ');
                event.target.value = '';
                return;
            }
            
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const restoredData = JSON.parse(e.target.result);
                    
                    if (!restoredData.totalStars && restoredData.totalStars !== 0) {
                        throw new Error('Invalid backup file');
                    }
                    
                    gameData = restoredData;
                    saveData();
                    updateUI();
                    resetChest();
                    alert('×”× ×ª×•× ×™× ×©×•×—×–×¨×• ×‘×”×¦×œ×—×”! âœ…\n×¡×š ×”×›×œ ×›×•×›×‘×™×: ' + gameData.totalStars);
                } catch (error) {
                    alert('×©×’×™××” ×‘×©×—×–×•×¨ ×”×§×•×‘×¥! âŒ\n×•×•×“× ×©×–×” ×§×•×‘×¥ ×’×™×‘×•×™ ×ª×§×™×Ÿ.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function init() {
            loadData();
            shufflePrizes();
            createChests();
            
            document.getElementById('resetBtn').addEventListener('click', resetChest);
            document.getElementById('resetDataBtn').addEventListener('click', resetAllData);
            document.getElementById('backupBtn').addEventListener('click', backupData);
            document.getElementById('restoreBtn').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });
            document.getElementById('fileInput').addEventListener('change', restoreData);
            
            document.getElementById('previewModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePreview();
                }
            });
        }
        
        function playSound(type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            if (type === 'unlock') {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(300, audioContext.currentTime);
                osc.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.1);
                gain.gain.setValueAtTime(0.2, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.1);
            } else if (type === 'open') {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(150, audioContext.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.3);
                gain.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.3);
            } else if (type === 'treasure') {
                const times = [0, 0.1, 0.2, 0.3];
                const freqs = [523, 659, 784, 1047];
                times.forEach(function(time, i) {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.frequency.value = freqs[i];
                    gain.gain.setValueAtTime(0.15, audioContext.currentTime + time);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.4);
                    osc.start(audioContext.currentTime + time);
                    osc.stop(audioContext.currentTime + time + 0.4);
                });
            }
        }
        
        function openChest(index) {
            if (selectedChestIndex !== null) return;
            
            selectedChestIndex = index;
            const stars = currentPrizes[index];
            
            // Disable all chests
            for (let i = 0; i < 3; i++) {
                const chest = document.getElementById(`chest${i}`);
                if (i !== index) {
                    chest.classList.add('disabled');
                }
            }
            
            const selectedChest = document.getElementById(`chest${index}`);
            const prizeContainer = selectedChest.querySelector('.prize-stars');
            
            playSound('unlock');
            
            setTimeout(function() {
                playSound('open');
            }, 200);
            
            selectedChest.classList.add('opened');
            prizeContainer.textContent = stars + ' â­';
            document.getElementById('instruction').textContent = '×”×§×•×¤×¡×” × ×¤×ª×—×”! ğŸ‰';
            
            setTimeout(function() {
                playSound('treasure');
            }, 800);
            
            createConfetti();
            
            setTimeout(function() {
                document.getElementById('result').innerHTML = '×–×›×™×ª ×‘-<span style="color: #f59e0b;">' + stars + ' ×›×•×›×‘×™×</span>! ğŸŠ';
                updateGameData(stars);
                
                // Reveal other chests after 2 seconds
                setTimeout(function() {
                    revealOtherChests(index);
                }, 2000);
            }, 1200);
        }
        
        function revealOtherChests(selectedIndex) {
            for (let i = 0; i < 3; i++) {
                if (i !== selectedIndex) {
                    const chest = document.getElementById(`chest${i}`);
                    const prizeContainer = chest.querySelector('.prize-stars');
                    const stars = currentPrizes[i];
                    
                    chest.classList.add('opened', 'revealed');
                    prizeContainer.textContent = stars + ' â­';
                    prizeContainer.style.opacity = '0.6';
                }
            }
            
            // Show summary message
            const allPrizes = currentPrizes.map((p, i) => i === selectedIndex ? `<strong>${p}</strong>` : p).join(', ');
            setTimeout(function() {
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML += '<br><span style="font-size: 0.8em; color: #999;">×”×ª×™×‘×•×ª ×”×›×™×œ×•: ' + allPrizes + ' ×›×•×›×‘×™×</span>';
            }, 1000);
        }
        
        function resetChest() {
            selectedChestIndex = null;
            shufflePrizes();
            createChests();
            document.getElementById('instruction').textContent = '×‘×—×¨ ×ª×™×‘×” ××—×ª ××ª×•×š 3! ğŸ²';
            document.getElementById('result').textContent = '';
        }
        
        function updateGameData(stars) {
            gameData.totalStars += stars;
            
            const today = new Date().toDateString();
            const lastOpenDate = gameData.lastOpenDate ? new Date(gameData.lastOpenDate).toDateString() : null;
            
            if (gameData.chestsToday === 0) {
                if (lastOpenDate && lastOpenDate !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    if (lastOpenDate === yesterday.toDateString()) {
                        gameData.streak += 1;
                    } else {
                        gameData.streak = 1;
                    }
                } else if (!lastOpenDate) {
                    gameData.streak = 1;
                }
            }
            
            gameData.chestsToday += 1;
            gameData.lastOpenDate = new Date().toISOString();
            
            gameData.history.push({
                date: new Date().toISOString(),
                stars: stars
            });
            
            saveData();
            updateUI();
        }
        
        function createConfetti() {
            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3'];
            for (let i = 0; i < 60; i++) {
                setTimeout(function() {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.body.appendChild(confetti);
                    
                    setTimeout(function() {
                        confetti.remove();
                    }, 3000);
                }, i * 20);
            }
        }
        
        function loadData() {
            const saved = localStorage.getItem('chestGameData');
            if (saved) {
                try {
                    gameData = JSON.parse(saved);
                    
                    if (!gameData.purchases) {
                        gameData.purchases = [];
                    }
                    
                    if (!gameData.usedItems) {
                        gameData.usedItems = [];
                    }
                    
                    const today = new Date().toDateString();
                    if (gameData.lastResetDate !== today) {
                        gameData.chestsToday = 0;
                        gameData.lastResetDate = today;
                        
                        if (gameData.lastOpenDate) {
                            const lastOpen = new Date(gameData.lastOpenDate);
                            const yesterday = new Date();
                            yesterday.setDate(yesterday.getDate() - 1);
                            
                            if (lastOpen.toDateString() !== yesterday.toDateString()) {
                                gameData.streak = 0;
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }
            updateUI();
        }
        
        function saveData() {
            try {
                localStorage.setItem('chestGameData', JSON.stringify(gameData));
            } catch (e) {
                console.error('Error saving data:', e);
            }
        }
        
        function updateUI() {
            document.getElementById('totalStars').textContent = gameData.totalStars + ' â­';
            document.getElementById('chestsToday').textContent = gameData.chestsToday;
            document.getElementById('streak').textContent = gameData.streak;
            updateHistory();
        }
        
        function updateHistory() {
            const historyList = document.getElementById('historyList');
            
            if (gameData.history.length === 0) {
                historyList.innerHTML = '<div class="empty-history">×¢×“×™×™×Ÿ ×œ× ×¤×ª×—×ª ×§×•×¤×¡××•×ª ××•×¦×¨ ğŸ’</div>';
                return;
            }
            
            historyList.innerHTML = '';
            gameData.history.slice().reverse().forEach(function(item) {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const date = document.createElement('div');
                date.className = 'history-date';
                const d = new Date(item.date);
                date.textContent = d.toLocaleDateString('he-IL') + ' ' + d.toLocaleTimeString('he-IL', {hour: '2-digit', minute:'2-digit'});
                
                const stars = document.createElement('div');
                stars.className = 'history-stars';
                stars.textContent = '+' + item.stars + ' â­';
                
                historyItem.appendChild(date);
                historyItem.appendChild(stars);
                historyList.appendChild(historyItem);
            });
        }
        
        function resetAllData() {
            const parentCode = prompt('×”×–×Ÿ ×§×•×“ ×”×•×¨×™× ×œ××™×¤×•×¡ (4 ×¡×¤×¨×•×ª):');
            
            if (parentCode === null) {
                return;
            }
            
            if (parentCode !== '1234') {
                alert('×§×•×“ ×©×’×•×™! âŒ');
                return;
            }
            
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©××ª×” ×¨×•×¦×” ×œ××¤×¡ ××ª ×›×œ ×”× ×ª×•× ×™×?')) {
                gameData = {
                    totalStars: 0,
                    chestsToday: 0,
                    streak: 0,
                    history: [],
                    lastOpenDate: null,
                    lastResetDate: new Date().toDateString(),
                    purchases: [],
                    usedItems: []
                };
                saveData();
                updateUI();
                resetChest();
                alert('×”× ×ª×•× ×™× ××•×¤×¡×• ×‘×”×¦×œ×—×”! âœ…');
            }
        }
        
        window.addEventListener('load', function() {
            init();
        });
    </script>
</body>
</html>